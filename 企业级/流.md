æµï¼ˆstreamï¼‰æ˜¯ç¼–ç¨‹ä¸­å¤„ç† æµå¼æ•°æ® çš„ æŠ½è±¡ æŽ¥å£ã€‚

Node.jsä¸­ stream æ¨¡å—ç”¨äºŽæž„å»ºå®žçŽ°äº† æµ æŽ¥å£çš„å¯¹è±¡ã€‚

ä¾‹å¦‚ï¼šHTTPæœåŠ¡å™¨çš„è¯·æ±‚ å’Œ process.stdout éƒ½æ˜¯æµçš„å®žä¾‹ã€‚

æµå¯ä»¥æ˜¯å¯è¯»çš„ï¼Œå¯å†™çš„æˆ–å¯è¯»å¯å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter çš„å®žä¾‹ã€‚

æµçš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

const stream = require('stream');

## æµçš„ç±»åž‹

4ç§åŸºæœ¬çš„æµç±»åž‹

å¯è¯»æµï¼ˆWritble): å¯å†™å…¥æ•°æ®çš„æµï¼Œå¦‚ï¼š fs.createWriteStream()ã€‚

å¯å†™æµï¼ˆReadable): å¯è¯»å–æ•°æ®çš„æµï¼Œå¦‚ï¼š fs.createReadStream()ã€‚

åŒå·¥æµï¼ˆDuplex): å¯è¯»åˆå¯å†™çš„æµï¼Œå¦‚ net.Socket

è½¬æ¢æµï¼ˆTransform): åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹æˆ–è½¬æ¢æ•°æ®çš„Duplexæµï¼Œå¦‚ zlib.createDeflate().

## å¯¹è±¡æ¨¡å¼

å½“åˆ›å»ºæµçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ objectMode é€‰é¡¹æŠŠæµå®žä¾‹ åˆ‡æ¢åˆ°å¯¹è±¡æ¨¡å¼ï¼Œå°†å·²å­˜åœ¨çš„æµåˆ‡æ¢åˆ°å¯¹è±¡æ¨¡åž‹æ˜¯ä¸å®‰å…¨çš„ã€‚

## æµä¸­çš„ç¼“å†²åŒº

å¯å†™æµ å’Œ å¯è¯»æµéƒ½ä¼šåœ¨å†…éƒ¨çš„ç¼“å†²åŒºä¸­å­˜å‚¨æ•°æ®ï¼Œå¯ä»¥åˆ†åˆ«ä½¿ç”¨ writable.writableBuffer æˆ– readable.readableBuffer æ¥èŽ·å–ã€‚

å¯ç¼“å†²çš„æ•°æ®å¤§å°å–å†³äºŽä¼ å…¥æµæž„é€ å‡½æ•°çš„ highWaterMark é€‰é¡¹ã€‚ å¯¹äºŽæ™®é€šçš„æµï¼Œ highWaterMark æŒ‡å®šæµå­èŠ‚çš„æ€»æ•°ã€‚

å¯¹äºŽå¯¹è±¡æ¨¡å¼çš„æµï¼ŒhighWaterMark æŒ‡å®šæµå¯¹è±¡çš„æ€»æ•°ã€‚

å½“è°ƒç”¨ stream.push(chunk) æ—¶ï¼Œæ•°æ®ä¼šè¢«ç¼“å†²åœ¨å¯è¯»æµä¸­ã€‚å¦‚æžœæµçš„ â€œæ¶ˆè´¹è€…â€ æ²¡æœ‰è°ƒç”¨ stream.read()ï¼Œåˆ™æ•°æ®ä¼šä¿ç•™åœ¨ å†…éƒ¨é˜Ÿåˆ— ä¸­ç›´åˆ°è¢«æ¶ˆè´¹ã€‚

ä¸€æ—¦å†…éƒ¨çš„å¯è¯»ç¼“å†²çš„æ€»å¤§å°è¾¾åˆ° highWaterMark æŒ‡å®šçš„ é˜€å€¼æ—¶ï¼Œæµä¼šæš‚æ—¶åœæ­¢ä»Žåº•å±‚èµ„æºè¯»å–æ•°æ®ï¼Œç›´åˆ°å½“å‰ç¼“å†²çš„æ•°æ®è¢«æ¶ˆè´¹ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæµä¼šåœæ­¢è°ƒç”¨å†…éƒ¨çš„ç”¨äºŽå¡«å……å¯è¯»ç¼“å†²çš„ readable._read()

å½“è°ƒç”¨ writable.write(chunk) æ—¶ï¼Œæ•°æ®ä¼šè¢«ç¼“å†²åœ¨å¯å†™æµä¸­ã€‚

å½“å†…éƒ¨çš„å¯å†™ç¼“å†²çš„æ€»å¤§å° å°äºŽ hightWaterMark è®¾ç½®çš„é˜€å€¼æ—¶ï¼Œ è°ƒç”¨ writable.write() ä¼šè¿”å›ž trueã€‚ä¸€æ—¦å†…éƒ¨ç¼“å†²çš„å¤§å°è¾¾åˆ°æˆ–è¶…è¿‡ highWaterMark æ—¶ï¼Œåˆ™ä¼šè¿”å›ž falseã€‚

ä¸ºäº†ä¿å­˜å†…å­˜ï¼ŒæŸäº› Stream API ä¼šé™åˆ¶ç¼“å†²åŒºï¼Œå¯ä»¥é¿å…è¯»å†™é€Ÿåº¦ä¸ä¸€è‡´å¼•èµ·çš„å†…å­˜çš„å´©æºƒã€‚

## å¯è¯»æµ

æ‰€æœ‰å¯è¯»æµéƒ½å®žçŽ°äº† stream.Readable ç±»å®šä¹‰çš„æŽ¥å£ã€‚

Node.jså¯è¯»æµæ˜¯å¯¹æä¾›æ•°æ®çš„æ¥æºçš„ä¸€ç§æŠ½è±¡ã€‚æ‰€æœ‰å¯è¯»æµéƒ½å®žçŽ°äº†stream.Readableç±»å®šä¹‰çš„æŽ¥å£ã€‚å¯è¯»æµå¸¸è§çš„ä¾‹å­åŒ…æ‹¬å®¢æˆ·ç«¯çš„HTTPå“åº”ï¼ŒæœåŠ¡å™¨çš„HTTPè¯·æ±‚ï¼Œfsçš„è¯»å–æµï¼Œzlibæµï¼Œcryptoæµï¼ŒTCP socketï¼Œå­è¿›ç¨‹stdoutä¸Žstderr, process.stdin.

## stream.Readable ç±»äº‹ä»¶

stream.Readable ç±»å®šä¹‰äº†å¦‚ä¸‹äº‹ä»¶ã€‚

1. closeäº‹ä»¶

closeäº‹ä»¶åœ¨æµæˆ–å…¶åº•å±‚èµ„æºï¼ˆå¦‚æ–‡ä»¶æè¿°ç¬¦ï¼‰è¢«å…³é—­æ—¶è§¦å‘ã€‚è¡¨æ˜Žä¸ä¼šå†è§¦å‘å…¶ä»–äº‹ä»¶ï¼Œä¹Ÿä¸ä¼šå†å‘ç”Ÿæ“ä½œã€‚

ä¸æ˜¯æ‰€æœ‰å¯è¯»æµéƒ½ä¼šè§¦å‘closeäº‹ä»¶ã€‚å¦‚æžœä½¿ç”¨emitCloseé€‰é¡¹åˆ›å»ºå¯è¯»æµï¼Œåˆ™å®ƒå°†å§‹ç»ˆå‘å‡ºcloseäº‹ä»¶ã€‚

2. dataäº‹ä»¶

dataäº‹ä»¶æ˜¯åœ¨æµå°†æ•°æ®å—ä¼ é€ç»™â€œæ¶ˆè´¹è€…â€åŽè§¦å‘ã€‚å¯¹äºŽéžå¯¹è±¡æ¨¡å¼çš„æµï¼Œæ•°æ®å—å¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–Bufferã€‚å¯¹äºŽå¯¹è±¡æ¨¡å¼çš„æµï¼Œæ•°æ®å—å¯ä»¥æ˜¯é™¤äº†nullçš„ä»»ä½•JavaScriptå€¼ã€‚

å½“è°ƒç”¨ readable.pipe(), readable.resume() æˆ–ç»‘å®šç›‘å¬å™¨åˆ° data äº‹ä»¶æ—¶ï¼Œæµä¼šè½¬æ¢åˆ°æµåŠ¨æ¨¡å¼ã€‚å½“è°ƒç”¨ readable.read()ä¸”æœ‰æ•°æ®å—è¿”å›žæ—¶ï¼Œä¹Ÿä¼šè§¦å‘dataäº‹ä»¶ã€‚

å¦‚æžœä½¿ç”¨ readable.setEncoding() ä¸ºæµæŒ‡å®š ðŸˆ¯ï¸ äº†é»˜è®¤çš„å­—ç¬¦ç¼–ç ï¼Œåˆ™ç›‘å¬å™¨å›žè°ƒä¼ å…¥çš„æ•°æ®ä¸ºå­—ç¬¦ä¸²ï¼Œå¦åˆ™ä¼ å…¥çš„æ•°æ®ä¸ºBufferã€‚


3. endäº‹ä»¶

end äº‹ä»¶åœ¨æµä¸­æ²¡æœ‰æ•°æ®å¯ä¾›æ¶ˆè´¹æ—¶è§¦å‘ã€‚

end äº‹ä»¶åªæœ‰åœ¨ä½ æ•°æ®è¢«å®Œå…¨æ¶ˆè´¹æŽ‰åŽæ‰ä¼šè§¦å‘ã€‚è¦æƒ³è§¦å‘è¯¥äº‹ä»¶ï¼Œå¯ä»¥å°†æµè½¬æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæˆ–åå¤è°ƒç”¨ stream.read() ç›´åˆ°æ•°æ®è¢«æ¶ˆè´¹å®Œã€‚

```js
const readable = getReadableStreamSomehow();

readable.on('data', (chunk) => {
 console.log(`æŽ¥æ”¶åˆ°${chunk.length}ä¸ªå­—èŠ‚çš„æ•°æ®`);
});

readable.on('end', () => {
 console.log(`å·²ç»æ²¡æœ‰æ•°æ®`);
});
```

4. erroräº‹ä»¶

erroräº‹ä»¶é€šå¸¸æ˜¯åœ¨å½“æµå› åº•å±‚å†…éƒ¨å‡ºé”™è€Œä¸èƒ½äº§ç”Ÿæ•°æ®ï¼Œæˆ–æŽ¨é€æ— æ•ˆçš„æ•°æ®å—æ—¶è§¦å‘ã€‚

ç›‘å¬å™¨å›žè°ƒå°†ä¼ é€’ä¸€ä¸ªErrorå¯¹è±¡

5. pauseäº‹ä»¶

è°ƒç”¨ stream.pause() å¹¶ä¸” readsFlowing ä¸ä¸º falseæ—¶ï¼Œä¼šå‘å‡ºpauseäº‹ä»¶ã€‚

6. readableäº‹ä»¶

readableäº‹ä»¶åœ¨å½“æµä¸­æœ‰æ•°æ®å¯ä¾›è¯»å–æ—¶è§¦å‘ã€‚

```js
const readable = getReadableStreamSomehow();

readable.on('readable', function() {
 // æœ‰æ•°æ®å¯è¯»å–
 let data;
 while(data = this.read()) {
  console.log(data);
 }
});
```

å½“åˆ°è¾¾æµæ•°æ®çš„å°½å¤´æ—¶ï¼Œreadableäº‹ä»¶ä¹Ÿä¼šè§¦å‘ï¼Œä½†æ˜¯åœ¨endäº‹ä»¶ä¹‹å‰è§¦å‘ã€‚

readable äº‹ä»¶è¡¨æ˜Žæµæœ‰æ–°çš„åŠ¨æ€ï¼Œè¦ä¹ˆæœ‰æ–°çš„æ•°æ®ï¼Œè¦ä¹ˆåˆ°è¾¾æµçš„å°½å¤´ã€‚å¯¹äºŽå‰è€…ï¼Œstream.read() ä¼šè¿”å›žå¯ç”¨çš„æ•°æ®ã€‚å¯¹äºŽåŽè€…ï¼Œstream.read() ä¼šè¿”å›ž null ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œfoo.txtæ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶ã€‚

```js
const fs = require('fs');
const rr = fs.createReadStream('data.txt');
rr.on('readable', () => {
 console.log(`è¯»å–çš„æ•°æ®${rr.read()}`);
});
rr.on('end', () => {
 console.log('ç»“æŸ');
});
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œ readable.pipe() å’Œ dataäº‹ä»¶çš„æœºåˆ¶æ¯” readable äº‹ä»¶æ›´å®¹æ˜“ç†è§£ã€‚å¤„ç† readable äº‹ä»¶å¯èƒ½é€ æˆåžåé‡å‡é«˜ã€‚

å¦‚æžœåŒæ—¶ä½¿ç”¨ readable äº‹ä»¶ å’Œ data äº‹ä»¶ï¼Œåˆ™ readable äº‹ä»¶ä¼šä¼˜å…ˆæŽ§åˆ¶æµï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è°ƒç”¨ stream.read() æ—¶æ‰ä¼šè§¦å‘ data äº‹ä»¶ã€‚ readableFlowing å±žæ€§ä¼šå˜æˆ falseã€‚

å½“ç§»é™¤ readable äº‹ä»¶æ—¶ï¼Œå¦‚æžœå­˜åœ¨dataäº‹ä»¶ç›‘å¬å™¨ï¼Œåˆ™æµä¼šå¼€å§‹æµåŠ¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ— é¡»è°ƒç”¨stream.resume() ä¹Ÿä¼šè§¦å‘dataäº‹ä»¶ã€‚

7. resumeäº‹ä»¶

è°ƒç”¨ stream.resume()å¹¶ä¸”readsFlowingä¸ä¸ºtrueæ—¶ï¼Œå°†å‘å‡ºresumeäº‹ä»¶ã€‚

## stream.Readable ç±»æ–¹æ³•

stream.Readableç±»åŒ…å«ä»¥ä¸‹å¸¸ç”¨çš„æ–¹æ³•ï¼š

1. destroy

readable.destroy([error]) æ–¹æ³•ç”¨äºŽé”€æ¯æµï¼Œå¹¶è§¦å‘ error äº‹ä»¶ å’Œ close äº‹ä»¶. è°ƒç”¨åŽï¼Œå¯è¯»æµå°†é‡Šæ”¾æ‰€æœ‰çš„å†…éƒ¨èµ„æºï¼Œä¸”å¿½è§†åŽç»­çš„push()è°ƒç”¨ã€‚

å®žçŽ°æµæ—¶ä¸åº”è¯¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯é‡å†™readable._destroy()

2. isPaused

readable.isPaused()æ–¹æ³•ç”¨äºŽè¿”å›žå¯è¯»æµå½“å‰çš„æ“çºµçŠ¶æ€ã€‚ä¸»è¦ç”¨äºŽ readable.pipe() åº•å±‚çš„æœºåˆ¶ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ— é¡»ç›´æŽ¥ä½¿ç”¨è¯¥æ–¹æ³•

```js
const readable = new stream.Readable();

readable.isPaused(); // === false
readable.pause();
readable.isPaused(); // === true
readable.resume();
readable.isPaused(); // ==== false
```

3. pause ä¸Ž resume

readable.pause() æ–¹æ³•ä½¿æµåŠ¨æ¨¡å¼çš„æµåœæ­¢è§¦å‘ data äº‹ä»¶ï¼Œå¹¶åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ã€‚ä»»ä½•å¯ç”¨çš„æ•°æ®éƒ½ä¼šä¿ç•™åœ¨å†…éƒ¨ç¼“å­˜ä¸­ã€‚

ç›¸å¯¹çš„, readable.resume() å°†è¢«æš‚åœâ¸ï¸çš„å¯è¯»æµæ¢å¤è§¦å‘dataäº‹ä»¶ï¼Œå¹¶å°†æµåˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ã€‚

```js
const fs = require('fs');

const readable = fs.createReadStream('data.txt');
readable.on('data', (chunk) => {
 console.log(`æŽ¥æ”¶åˆ°${chunk.length}å­—èŠ‚çš„æ•°æ®`);
 // æš‚åœ
 readable.pause();

 console.log('æš‚åœä¸€ç§’');
 setTimeout(() => {
  console.log('æ•°æ®é‡æ–°å¼€å§‹æµåŠ¨');
  // ç»§ç»­
  readable.resume();
 },1000);
});

readable.on('end', () => {
 console.log('ç»“æŸ');
});
```

4. pipe

readable.pipe(destination[, options]) æ–¹æ³•ç”¨äºŽç»‘å®š å¯å†™æµ åˆ° å¯è¯»æµï¼Œå°† å¯è¯»æµ è‡ªåŠ¨åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œå¹¶å°†å¯è¯»æµçš„æ‰€æœ‰æ•°æ®æŽ¨é€åˆ°ç»‘å®šçš„å¯å†™æµã€‚

æ•°æ®æµä¼šè¢«è‡ªåŠ¨ç®¡ç†ï¼Œæ‰€ä»¥å³ä½¿å¯è¯»æµæ›´å¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ã€‚

å°†å¯è¯»æµçš„æ‰€æœ‰æ•°æ®é€šè¿‡ç®¡é“æŽ¨é€åˆ° write-data.txt æ–‡ä»¶

```js
const fs = require('fs')

const readable = fs.createReadStream('data.txt');

const writable = fs.createWriteStream('write-data.txt');

// readable çš„æ‰€æœ‰æ•°æ®éƒ½æŽ¨é€åˆ° write-data.txt
readable.pipe(writable);
```

å¯ä»¥åœ¨å•ä¸ªå¯è¯»æµä¸Šç»‘å®šå¤šä¸ªå¯å†™æµã€‚

```js
readable.pipe() // ä¼šè¿”å›žç›®æ ‡æµçš„å¼•ç”¨ï¼Œè¿™æ ·å°±å¯ä»¥å¯¹æµè¿›è¡Œé“¾å¼çš„ç®¡é“æ“ä½œã€‚

const fs = require('fs');
const zlib = require('zlib');

const readable = fs.createReadStream('data.txt');
const gzip = zlib.createGzip();
const writable2 = fs.createWriteStream('write-data.txt.gz');

// åœ¨å•ä¸ªå¯è¯»æµä¸Šç»‘å®šå¤šä¸ªå¯å†™æµ
readable.pipe(gzip).pipe(writable2);
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æ¥æºå¯è¯»æµè§¦å‘ end äº‹ä»¶æ—¶ï¼Œç›®æ ‡å¯å†™æµ ä¹Ÿä¼šè°ƒç”¨ stream.end() ç»“æŸå†™å…¥ã€‚

è‹¥è¦ç¦ç”¨è¿™ç§é»˜è®¤è¡Œä¸ºï¼Œendé€‰é¡¹åº”è®¾ä¸º false ï¼Œè¿™æ ·ç›®æ ‡æµå°±å›žä¿æŒæ‰“å¼€ã€‚

```js
reader.pipe(writer, { end: false });
reader.on('end', () => {
 writer.end('ç»“æŸ');
});
```

å¦‚æžœå¯è¯»æµå‘ç”Ÿé”™è¯¯ðŸ™…ðŸ™…â€â™‚ï¸ï¼Œç›®æ ‡å¯å†™æµä¸ä¼šè‡ªåŠ¨å…³é—­ï¼Œéœ€è¦æ‰‹åŠ¨å…³é—­æ‰€æœ‰æµä»¥é¿å…å†…å­˜æ³„æ¼ã€‚

process.stderr å’Œ process.stdout å¯å†™çš„æµåœ¨ Node.js è¿›ç¨‹é€€å‡ºä¹‹å‰æ°¸è¿œä¸ä¼šå…³é—­ï¼Œæ— è®ºæŒ‡å®šçš„é€‰é¡¹å¦‚ä½•ã€‚

5. read

readable.read([size]) æ–¹æ³•ç”¨äºŽä»Žå†…éƒ¨ç¼“å†²æ‹‰å–å¹¶è¿”å›žæ•°æ®ã€‚å…¶ä¸­ï¼Œsize æŒ‡å®šè¦è¯»å–çš„æ•°æ®çš„å­—èŠ‚æ•°ã€‚å¦‚æžœæ²¡æœ‰æŒ‡å®š size å‚æ•°ï¼Œåˆ™è¿”å›žå†…éƒ¨ç¼“å†²ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚

è¯¥æ–¹æ³•å¦‚æžœæ²¡æœ‰å¯è¯»çš„æ•°æ®ï¼Œåˆ™è¿”å›žnullã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œreadable.read() è¿”å›žçš„æ•°æ®æ˜¯ Bufferå¯¹è±¡ï¼Œé™¤éžä½¿ç”¨ readable.setEncoding() æŒ‡å®šå­—ç¬¦ç¼–ç æˆ–æµ å¤„äºŽå¯¹è±¡æ¨¡å¼ã€‚

å¦‚æžœå¯è¯»çš„æ•°æ®ä¸è¶³size ä¸ªå­—èŠ‚ï¼Œåˆ™è¿”å›žå†…éƒ¨ç¼“å†²å‰©ä½™çš„æ•°æ®ï¼Œå¦‚æžœæµå·²ç»ç»“æŸåˆ™ è¿”å›žnull

readable.read() åº”è¯¥åªå¯¹ å¤„äºŽæš‚åœæ¨¡å¼çš„å¯è¯»æµè°ƒç”¨ã€‚åœ¨æµåŠ¨æ¨¡å¼ä¸­ï¼Œ readable.read() ä¼šè‡ªåŠ¨è°ƒç”¨ç›´åˆ°å†…éƒ¨ç¼“å†²çš„æ•°æ®å®Œå…¨è€—å°½ã€‚

å¦‚æžœ readable.read() è¿”å›žä¸€ä¸ªæ•°æ®å—ï¼Œåˆ™data äº‹ä»¶ä¹Ÿä¼šè§¦å‘ã€‚

endäº‹ä»¶è§¦å‘åŽå†è°ƒç”¨ stream.read([size]) ä¼šè¿”å›žnullï¼Œä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚

```js
const fs = require('fs');
const readable = fs.createReadStream('data.txt');

// è®¾ç½®å­—ç¬¦ç¼–ç 
readable.setEncoding('utf-8');

// è¯»å–æ•°æ®
readable.on('readable', () => {
 let chunk;
 while (null !== (chunk = readable.read(10))) {
  console.log
 }
})

readable.on('end', () =>{
 console.log()
})
```


