æµï¼ˆstreamï¼‰æ˜¯ç¼–ç¨‹ä¸­å¤„ç† æµå¼æ•°æ® çš„ æŠ½è±¡ æ¥å£ã€‚

Node.jsä¸­ stream æ¨¡å—ç”¨äºæ„å»ºå®ç°äº† æµ æ¥å£çš„å¯¹è±¡ã€‚

ä¾‹å¦‚ï¼šHTTPæœåŠ¡å™¨çš„è¯·æ±‚ å’Œ process.stdout éƒ½æ˜¯æµçš„å®ä¾‹ã€‚

æµå¯ä»¥æ˜¯å¯è¯»çš„ï¼Œå¯å†™çš„æˆ–å¯è¯»å¯å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter çš„å®ä¾‹ã€‚

æµçš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

const stream = require('stream');

## æµçš„ç±»å‹

4ç§åŸºæœ¬çš„æµç±»å‹

å¯è¯»æµï¼ˆWritble): å¯å†™å…¥æ•°æ®çš„æµï¼Œå¦‚ï¼š fs.createWriteStream()ã€‚

å¯å†™æµï¼ˆReadable): å¯è¯»å–æ•°æ®çš„æµï¼Œå¦‚ï¼š fs.createReadStream()ã€‚

åŒå·¥æµï¼ˆDuplex): å¯è¯»åˆå¯å†™çš„æµï¼Œå¦‚ net.Socket

è½¬æ¢æµï¼ˆTransform): åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹æˆ–è½¬æ¢æ•°æ®çš„Duplexæµï¼Œå¦‚ zlib.createDeflate().

## å¯¹è±¡æ¨¡å¼

å½“åˆ›å»ºæµçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ objectMode é€‰é¡¹æŠŠæµå®ä¾‹ åˆ‡æ¢åˆ°å¯¹è±¡æ¨¡å¼ï¼Œå°†å·²å­˜åœ¨çš„æµåˆ‡æ¢åˆ°å¯¹è±¡æ¨¡å‹æ˜¯ä¸å®‰å…¨çš„ã€‚

## æµä¸­çš„ç¼“å†²åŒº

å¯å†™æµ å’Œ å¯è¯»æµéƒ½ä¼šåœ¨å†…éƒ¨çš„ç¼“å†²åŒºä¸­å­˜å‚¨æ•°æ®ï¼Œå¯ä»¥åˆ†åˆ«ä½¿ç”¨ writable.writableBuffer æˆ– readable.readableBuffer æ¥è·å–ã€‚

å¯ç¼“å†²çš„æ•°æ®å¤§å°å–å†³äºä¼ å…¥æµæ„é€ å‡½æ•°çš„ highWaterMark é€‰é¡¹ã€‚ å¯¹äºæ™®é€šçš„æµï¼Œ highWaterMark æŒ‡å®šæµå­èŠ‚çš„æ€»æ•°ã€‚

å¯¹äºå¯¹è±¡æ¨¡å¼çš„æµï¼ŒhighWaterMark æŒ‡å®šæµå¯¹è±¡çš„æ€»æ•°ã€‚

å½“è°ƒç”¨ stream.push(chunk) æ—¶ï¼Œæ•°æ®ä¼šè¢«ç¼“å†²åœ¨å¯è¯»æµä¸­ã€‚å¦‚æœæµçš„ â€œæ¶ˆè´¹è€…â€ æ²¡æœ‰è°ƒç”¨ stream.read()ï¼Œåˆ™æ•°æ®ä¼šä¿ç•™åœ¨ å†…éƒ¨é˜Ÿåˆ— ä¸­ç›´åˆ°è¢«æ¶ˆè´¹ã€‚

ä¸€æ—¦å†…éƒ¨çš„å¯è¯»ç¼“å†²çš„æ€»å¤§å°è¾¾åˆ° highWaterMark æŒ‡å®šçš„ é˜€å€¼æ—¶ï¼Œæµä¼šæš‚æ—¶åœæ­¢ä»åº•å±‚èµ„æºè¯»å–æ•°æ®ï¼Œç›´åˆ°å½“å‰ç¼“å†²çš„æ•°æ®è¢«æ¶ˆè´¹ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæµä¼šåœæ­¢è°ƒç”¨å†…éƒ¨çš„ç”¨äºå¡«å……å¯è¯»ç¼“å†²çš„ readable._read()

å½“è°ƒç”¨ writable.write(chunk) æ—¶ï¼Œæ•°æ®ä¼šè¢«ç¼“å†²åœ¨å¯å†™æµä¸­ã€‚

å½“å†…éƒ¨çš„å¯å†™ç¼“å†²çš„æ€»å¤§å° å°äº hightWaterMark è®¾ç½®çš„é˜€å€¼æ—¶ï¼Œ è°ƒç”¨ writable.write() ä¼šè¿”å› trueã€‚ä¸€æ—¦å†…éƒ¨ç¼“å†²çš„å¤§å°è¾¾åˆ°æˆ–è¶…è¿‡ highWaterMark æ—¶ï¼Œåˆ™ä¼šè¿”å› falseã€‚

ä¸ºäº†ä¿å­˜å†…å­˜ï¼ŒæŸäº› Stream API ä¼šé™åˆ¶ç¼“å†²åŒºï¼Œå¯ä»¥é¿å…è¯»å†™é€Ÿåº¦ä¸ä¸€è‡´å¼•èµ·çš„å†…å­˜çš„å´©æºƒã€‚

## å¯è¯»æµ

æ‰€æœ‰å¯è¯»æµéƒ½å®ç°äº† stream.Readable ç±»å®šä¹‰çš„æ¥å£ã€‚

Node.jså¯è¯»æµæ˜¯å¯¹æä¾›æ•°æ®çš„æ¥æºçš„ä¸€ç§æŠ½è±¡ã€‚æ‰€æœ‰å¯è¯»æµéƒ½å®ç°äº†stream.Readableç±»å®šä¹‰çš„æ¥å£ã€‚å¯è¯»æµå¸¸è§çš„ä¾‹å­åŒ…æ‹¬å®¢æˆ·ç«¯çš„HTTPå“åº”ï¼ŒæœåŠ¡å™¨çš„HTTPè¯·æ±‚ï¼Œfsçš„è¯»å–æµï¼Œzlibæµï¼Œcryptoæµï¼ŒTCP socketï¼Œå­è¿›ç¨‹stdoutä¸stderr, process.stdin.

## stream.Readable ç±»äº‹ä»¶

stream.Readable ç±»å®šä¹‰äº†å¦‚ä¸‹äº‹ä»¶ã€‚

1. closeäº‹ä»¶

closeäº‹ä»¶åœ¨æµæˆ–å…¶åº•å±‚èµ„æºï¼ˆå¦‚æ–‡ä»¶æè¿°ç¬¦ï¼‰è¢«å…³é—­æ—¶è§¦å‘ã€‚è¡¨æ˜ä¸ä¼šå†è§¦å‘å…¶ä»–äº‹ä»¶ï¼Œä¹Ÿä¸ä¼šå†å‘ç”Ÿæ“ä½œã€‚

ä¸æ˜¯æ‰€æœ‰å¯è¯»æµéƒ½ä¼šè§¦å‘closeäº‹ä»¶ã€‚å¦‚æœä½¿ç”¨emitCloseé€‰é¡¹åˆ›å»ºå¯è¯»æµï¼Œåˆ™å®ƒå°†å§‹ç»ˆå‘å‡ºcloseäº‹ä»¶ã€‚

2. dataäº‹ä»¶

dataäº‹ä»¶æ˜¯åœ¨æµå°†æ•°æ®å—ä¼ é€ç»™â€œæ¶ˆè´¹è€…â€åè§¦å‘ã€‚å¯¹äºéå¯¹è±¡æ¨¡å¼çš„æµï¼Œæ•°æ®å—å¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–Bufferã€‚å¯¹äºå¯¹è±¡æ¨¡å¼çš„æµï¼Œæ•°æ®å—å¯ä»¥æ˜¯é™¤äº†nullçš„ä»»ä½•JavaScriptå€¼ã€‚

å½“è°ƒç”¨ readable.pipe(), readable.resume() æˆ–ç»‘å®šç›‘å¬å™¨åˆ° data äº‹ä»¶æ—¶ï¼Œæµä¼šè½¬æ¢åˆ°æµåŠ¨æ¨¡å¼ã€‚å½“è°ƒç”¨ readable.read()ä¸”æœ‰æ•°æ®å—è¿”å›æ—¶ï¼Œä¹Ÿä¼šè§¦å‘dataäº‹ä»¶ã€‚

å¦‚æœä½¿ç”¨ readable.setEncoding() ä¸ºæµæŒ‡å®š ğŸˆ¯ï¸ äº†é»˜è®¤çš„å­—ç¬¦ç¼–ç ï¼Œåˆ™ç›‘å¬å™¨å›è°ƒä¼ å…¥çš„æ•°æ®ä¸ºå­—ç¬¦ä¸²ï¼Œå¦åˆ™ä¼ å…¥çš„æ•°æ®ä¸ºBufferã€‚


3. endäº‹ä»¶

end äº‹ä»¶åœ¨æµä¸­æ²¡æœ‰æ•°æ®å¯ä¾›æ¶ˆè´¹æ—¶è§¦å‘ã€‚

end äº‹ä»¶åªæœ‰åœ¨ä½ æ•°æ®è¢«å®Œå…¨æ¶ˆè´¹æ‰åæ‰ä¼šè§¦å‘ã€‚è¦æƒ³è§¦å‘è¯¥äº‹ä»¶ï¼Œå¯ä»¥å°†æµè½¬æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæˆ–åå¤è°ƒç”¨ stream.read() ç›´åˆ°æ•°æ®è¢«æ¶ˆè´¹å®Œã€‚

```js
const readable = getReadableStreamSomehow();

readable.on('data', (chunk) => {
 console.log(`æ¥æ”¶åˆ°${chunk.length}ä¸ªå­—èŠ‚çš„æ•°æ®`);
});

readable.on('end', () => {
 console.log(`å·²ç»æ²¡æœ‰æ•°æ®`);
});
```

4. erroräº‹ä»¶

erroräº‹ä»¶é€šå¸¸æ˜¯åœ¨å½“æµå› åº•å±‚å†…éƒ¨å‡ºé”™è€Œä¸èƒ½äº§ç”Ÿæ•°æ®ï¼Œæˆ–æ¨é€æ— æ•ˆçš„æ•°æ®å—æ—¶è§¦å‘ã€‚

ç›‘å¬å™¨å›è°ƒå°†ä¼ é€’ä¸€ä¸ªErrorå¯¹è±¡

5. pauseäº‹ä»¶

è°ƒç”¨ stream.pause() å¹¶ä¸” readsFlowing ä¸ä¸º falseæ—¶ï¼Œä¼šå‘å‡ºpauseäº‹ä»¶ã€‚

6. readableäº‹ä»¶

readableäº‹ä»¶åœ¨å½“æµä¸­æœ‰æ•°æ®å¯ä¾›è¯»å–æ—¶è§¦å‘ã€‚

```js
const readable = getReadableStreamSomehow();

readable.on('readable', function() {
 // æœ‰æ•°æ®å¯è¯»å–
 let data;
 while(data = this.read()) {
  console.log(data);
 }
});
```

å½“åˆ°è¾¾æµæ•°æ®çš„å°½å¤´æ—¶ï¼Œreadableäº‹ä»¶ä¹Ÿä¼šè§¦å‘ï¼Œä½†æ˜¯åœ¨endäº‹ä»¶ä¹‹å‰è§¦å‘ã€‚

readable äº‹ä»¶è¡¨æ˜æµæœ‰æ–°çš„åŠ¨æ€ï¼Œè¦ä¹ˆæœ‰æ–°çš„æ•°æ®ï¼Œè¦ä¹ˆåˆ°è¾¾æµçš„å°½å¤´ã€‚å¯¹äºå‰è€…ï¼Œstream.read() ä¼šè¿”å›å¯ç”¨çš„æ•°æ®ã€‚å¯¹äºåè€…ï¼Œstream.read() ä¼šè¿”å› null ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œfoo.txtæ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶ã€‚

```js
const fs = require('fs');
const rr = fs.createReadStream('data.txt');
rr.on('readable', () => {
 console.log(`è¯»å–çš„æ•°æ®${rr.read()}`);
});
rr.on('end', () => {
 console.log('ç»“æŸ');
});
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œ readable.pipe() å’Œ dataäº‹ä»¶çš„æœºåˆ¶æ¯” readable äº‹ä»¶æ›´å®¹æ˜“ç†è§£ã€‚å¤„ç† readable äº‹ä»¶å¯èƒ½é€ æˆååé‡å‡é«˜ã€‚

å¦‚æœåŒæ—¶ä½¿ç”¨ readable äº‹ä»¶ å’Œ data äº‹ä»¶ï¼Œåˆ™ readable äº‹ä»¶ä¼šä¼˜å…ˆæ§åˆ¶æµï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è°ƒç”¨ stream.read() æ—¶æ‰ä¼šè§¦å‘ data äº‹ä»¶ã€‚ readableFlowing å±æ€§ä¼šå˜æˆ falseã€‚

å½“ç§»é™¤ readable äº‹ä»¶æ—¶ï¼Œå¦‚æœå­˜åœ¨dataäº‹ä»¶ç›‘å¬å™¨ï¼Œåˆ™æµä¼šå¼€å§‹æµåŠ¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ— é¡»è°ƒç”¨stream.resume() ä¹Ÿä¼šè§¦å‘dataäº‹ä»¶ã€‚

7. resumeäº‹ä»¶

è°ƒç”¨ stream.resume()å¹¶ä¸”readsFlowingä¸ä¸ºtrueæ—¶ï¼Œå°†å‘å‡ºresumeäº‹ä»¶ã€‚




